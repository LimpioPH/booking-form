<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Cleaning Service</title>
    <style>
        /* (styles unchanged from original) */
        /* ... Keep all styles here as-is from your file */
        .single-booking-note,
        .availability-note {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Limpio PH Booking</h1>
            <p>Book your sofa cleaning today</p>
        </div>
        
        <div class="form-container">
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator status-offline" id="statusIndicator"></span>
                <span id="statusText">Connecting to booking system...</span>
            </div>

            <div class="success-message" id="successMessage">
                <div>
                    Thank you! Your booking request has been submitted successfully. We'll contact you soon to confirm your appointment.
                </div>
                <div class="booking-id" id="bookingId" style="display: none;">
                    <strong>Booking Reference:</strong> <span id="bookingIdText"></span>
                </div>
            </div>
            
            <div class="error-message" id="errorMessage">
                There was an error submitting your request. Please try again or contact us directly.
            </div>

            <div class="loading" id="loadingAvailability">
                Loading available dates and times...
            </div>
            
            <form id="bookingForm" style="display: none;">
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" name="firstName" required placeholder="Your first name">
                </div>

                <div class="form-group">
                    <label for="phone">Contact Number *</label>
                    <input type="tel" id="phone" name="phone" required placeholder="09XX XXX XXXX">
                </div>

                <div class="form-group">
                    <label for="address">Complete Address *</label>
                    <input type="text" id="address" name="address" placeholder="" required>
                </div>

                <div class="datetime-container">
                    <div class="form-group">
                        <label for="availableDate">Available Date *</label>
                        <select id="availableDate" name="availableDate" required>
                            <option value="">Select a date</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="availableTime">Available Time *</label>
                        <select id="availableTime" name="availableTime" required>
                            <option value="">Select a time</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    üóïÔ∏è Request Booking
                </button>
            </form>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyv6-dvOHBPHQ1lHHRTPPOB21vX6pXjmUScUx83G3L8d02Sf6qdHd6OsxA05-1OXO6V/exec';
        let availabilityData = {};
        let isOnline = false;

        function updateConnectionStatus(online, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            isOnline = online;
            indicator.className = `status-indicator ${online ? 'status-online' : 'status-offline'}`;
            statusText.textContent = message;
        }

        async function loadAvailability() {
            try {
                updateConnectionStatus(false, 'Loading availability...');

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    availabilityData = data.availability || {};
                    populateDates();
                    updateConnectionStatus(true, 'Connected - Live availability loaded');
                    document.getElementById('loadingAvailability').style.display = 'none';
                    document.getElementById('bookingForm').style.display = 'block';
                } else {
                    throw new Error(data.message || 'Server error');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                loadFallbackAvailability();
            }
        }

        function loadFallbackAvailability() {
            updateConnectionStatus(false, 'Using offline schedule - Limited availability');
            const today = new Date();
            availabilityData = {};
            for (let i = 1; i <= 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                if (date.getDay() !== 0 && date.getDay() !== 6) {
                    availabilityData[dateString] = ["9:00 AM", "11:00 AM", "2:00 PM", "4:00 PM"];
                }
            }
            populateDates();
            document.getElementById('loadingAvailability').style.display = 'none';
            document.getElementById('bookingForm').style.display = 'block';
        }

        function populateDates() {
            const dateSelect = document.getElementById('availableDate');
            dateSelect.innerHTML = '<option value="">Select a date</option>';
            const dates = Object.keys(availabilityData).sort();
            if (dates.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No dates available';
                option.disabled = true;
                dateSelect.appendChild(option);
                return;
            }
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                const dateObj = new Date(date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
                });
                option.textContent = formattedDate;
                dateSelect.appendChild(option);
            });
        }

        function populateTimes() {
            const dateSelect = document.getElementById('availableDate');
            const timeSelect = document.getElementById('availableTime');
            const selectedDate = dateSelect.value;
            timeSelect.innerHTML = '<option value="">Select a time</option>';
            if (selectedDate && availabilityData[selectedDate]) {
                availabilityData[selectedDate].forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    timeSelect.appendChild(option);
                });
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'üì§ Submitting...';

            try {
                const formData = {
                    firstName: document.getElementById('firstName').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    date: document.getElementById('availableDate').value,
                    time: document.getElementById('availableTime').value,
                    submittedAt: new Date().toISOString()
                };

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.status === 'success') {
                    successMessage.style.display = 'block';
                    if (result.bookingId) {
                        document.getElementById('bookingId').style.display = 'block';
                        document.getElementById('bookingIdText').textContent = result.bookingId;
                    }
                    document.getElementById('bookingForm').reset();
                    document.getElementById('availableTime').innerHTML = '<option value="">Select a time</option>';
                    setTimeout(() => {
                        loadAvailability();
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Submission failed');
                }
            } catch (error) {
                console.error('Submission error:', error);
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error: ' + error.message;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üóïÔ∏è Request Booking';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadAvailability();
            document.getElementById('availableDate').addEventListener('change', populateTimes);
            document.getElementById('bookingForm').addEventListener('submit', handleSubmit);
        });
    </script>
</body>
</html>
